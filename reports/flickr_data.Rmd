---
title: "Data - Flickr"
author: "Jan Overgoor"
params:
  date: "Sys.Date()"
output:
  pdf_document:
    toc: no
---

* Source: [http://socialnetworks.mpi-sws.org/data-wosn2008.html](http://socialnetworks.mpi-sws.org/data-wosn2008.html)
* Paper:  [https://people.mpi-sws.org/~amislove/publications/Growth-WOSN.pdf](https://people.mpi-sws.org/~amislove/publications/Growth-WOSN.pdf)


```{r setup, include=F}
library(knitr)
knitr::opts_chunk$set(echo=F, warning=F, cache=T, message=F, fig.width=6, fig.height=2.5)
source("helper.R")
```

Read data

```{r}
d <- read_tsv("~/projects/choosing_to_grow/choose2grow/data/flickr-growth.txt.gz",
              col_names=c('from','to','ds'), col_types='iiD')

nodes <- full_join(
    d %>% mutate(node=from) %>% group_by(node) %>% summarize(n_out=n(), first_out=min(ds)),
    d %>% mutate(node=to  ) %>% group_by(node) %>% summarize(n_in =n(), first_in =max(ds)),
    by='node'
  ) %>%
  mutate(n_out=ifelse(is.na(n_out), 0, n_out),
         n_in =ifelse(is.na(n_in ), 0, n_in ))
```

* total number of nodes: `r nrow(nodes)`
* total number of edges: `r nrow(d)`
* avg in-degree `r mean(nodes$n_in)`
* avg out-degree `r mean(nodes$n_out)`
* **why are they the same?**
    - about 60% of edges are reciprocated, so not 100%..
    - $\delta$ in/out seems reasonable in the extremes (natural limit to out, except for scammers)
    - overflow issue?

Number of connections by day

```{r}
d %>% group_by(ds) %>% summarize(n=n()) %>% ggplot(aes(ds, n)) + geom_point() +
  scale_y_continuous("Number of new edges", limits=c(0, 3e+05)) +
  xlab("Date") + my_theme()
```

In/out degree

```{r plot_degdist}
Rmisc::multiplot(
  plot_powerlaw_cdf(nodes$n_out, title="cdf - Out links",
                    xlab="(log) Number of Links out", ylab="(log) Number of Accounts"),
  plot_powerlaw_cdf(nodes$n_in, title="cdf - In links",
                    xlab="(log) Number of Links in", ylab="(log) Number of Accounts"),
  cols=2
)
```


## Jackson R

```{r}
DFj <- nodes %>% mutate(degree=n_in) %>%
  group_by(degree) %>% summarize(n=n()) %>% ungroup() %>%
  arrange(degree) %>%
  complete(degree = seq(max(degree)), fill=list(n=0)) %>%
  mutate(D_d=cumsum(n), F_d=cumsum(n)/sum(n))

rstar = r_jackson(DFj$F_d, mean(nodes$n_out))
r = rstar/(1+rstar)
```

* Fitted $r^{*}=$ `r round(rstar, 3)`
* Fitted $r=\frac{r^{*}}{1+r^{*}}=$ `r round(r, 3)`


## Model results on 2016-11-05

```{r read_data}
ds = '061105'
fn <- sprintf("~/projects/choosing_to_grow/choose2grow/data/flickr-growth_choices_%s.csv", ds)
DM <- read_csv(fn, col_types='iiiii') %>%
  mutate(
    is_fof=as.factor(ifelse(is.na(hops), 0, ifelse(hops > 2, 0, 1))),
    hops_f=as.factor(ifelse(is.na(hops), 'none', ifelse(hops >=6 , '6+', as.character(hops)))),
    hops_f=factor(hops_f, levels=c("none","2","3","4","5","6+"))
  )
```

```{r sample_data}
set.seed(100)
examples <- DM %>% distinct(choice_id) %>% sample_n(12000)

H_train <- DM %>% inner_join(head(examples, 10000), by='choice_id') %>%
     group_by(choice_id) %>% mutate(alt_id=row_number()) %>% ungroup() %>%
     select(choice_id, alt_id, y, deg:hops_f) %>%
     mlogit.data(shape="long", chid.var='choice_id', choice="y", alt.var='alt_id')

H_test <- DM %>% inner_join(tail(examples, 2000), by='choice_id') %>%
     group_by(choice_id) %>% mutate(alt_id=row_number()) %>% ungroup() %>%
     select(choice_id, alt_id, y, deg:hops_f) %>%
     mlogit.data(shape="long", chid.var='choice_id', choice="y", alt.var='alt_id')
```

```{r write_data}
H_train %>%
  mutate(y=ifelse(y, 1, 0)) %>%
  select(choice_id,y,deg,fof=is_fof) %>%
  write_csv("~/projects/choosing_to_grow/choose2grow/data/flickr-growth_choices_py.csv")
```

```{r model_models}
#f0 <- mlogit(y ~ log(deg+1) | 0, H_train)
f1 <- mlogit(y ~ log(deg+1) + recip | 0, H_train)
f2 <- mlogit(y ~ log(deg+1) + recip + is_fof | 0, H_train)
f3 <- mlogit(y ~ log(deg+1) + recip + hops_f | 0, H_train)
```

```{r sg_text}
stargazer::stargazer(
  f1, f2, f3,
  dep.var.caption = "",
  covariate.labels = c("log In-Degree", "Reciprocal", "Is FoF",
                       "2 Hops", "3 Hops", "4 Hops", "5 Hops", "6+ Hops"),
  header=FALSE, 
  type='text')
```

```{r accuracy}
print("Train accuracy:")
c(acc(f1, H_train), acc(f2, H_train), acc(f3, H_train)) %>%
  round(4) %>% paste(collapse=' & ') %>% print()
print("Test accuracy:")
c(acc(f1, H_test), acc(f2, H_test), acc(f3, H_test)) %>%
  round(4) %>% paste(collapse=' & ') %>% print()
```

\newpage
## Model results on 2017-03-01

```{r read_data2}
ds = '070301'
fn <- sprintf("~/projects/choosing_to_grow/choose2grow/data/flickr-growth_choices_%s.csv", ds)
DM <- read_csv(fn, col_types='iiiii') %>%
  mutate(
    is_fof=as.factor(ifelse(is.na(hops), 0, ifelse(hops > 2, 0, 1))),
    hops_f=as.factor(ifelse(is.na(hops), 'none', ifelse(hops >=6 , '6+', as.character(hops)))),
    hops_f=factor(hops_f, levels=c("none","2","3","4","5","6+"))
  )
```

```{r sample_data2}
set.seed(200)
examples <- DM %>% distinct(choice_id) %>% sample_n(12000)

H_train <- DM %>% inner_join(head(examples, 10000), by='choice_id') %>%
     group_by(choice_id) %>% mutate(alt_id=row_number()) %>% ungroup() %>%
     select(choice_id, alt_id, y, deg:hops_f) %>%
     mlogit.data(shape="long", chid.var='choice_id', choice="y", alt.var='alt_id')

H_test <- DM %>% inner_join(tail(examples, 2000), by='choice_id') %>%
     group_by(choice_id) %>% mutate(alt_id=row_number()) %>% ungroup() %>%
     select(choice_id, alt_id, y, deg:hops_f) %>%
     mlogit.data(shape="long", chid.var='choice_id', choice="y", alt.var='alt_id')
```

```{r model_models2}
#f0 <- mlogit(y ~ log(deg+1) | 0, H_train)
f1 <- mlogit(y ~ log(deg+1) + recip | 0, H_train)
f2 <- mlogit(y ~ log(deg+1) + recip + is_fof | 0, H_train)
f3 <- mlogit(y ~ log(deg+1) + recip + hops_f | 0, H_train)
```

```{r sg_text2}
stargazer::stargazer(
  f1, f2, f3,
  dep.var.caption = "",
  covariate.labels = c("log In-Degree", "Reciprocal", "Is FoF",
                       "2 Hops", "3 Hops", "4 Hops", "5 Hops", "6+ Hops"),
  header=FALSE, 
  type='text')
```

```{r accuracy2}
print("Train accuracy:")
c(acc(f1, H_train), acc(f2, H_train), acc(f3, H_train)) %>%
  round(4) %>% paste(collapse=' & ') %>% print()
print("Test accuracy:")
c(acc(f1, H_test), acc(f2, H_test), acc(f3, H_test)) %>%
  round(4) %>% paste(collapse=' & ') %>% print()
```
