---
title: "MAG - 'Computer network'"
author: "Jan Overgoor"
params:
  date: "Sys.Date()"
output:
  pdf_document:
    toc: no
  html_document:
    code_folding: hide
    self_contained: yes
    toc: yes
    toc_depth: 2
---

```
to build from command-line, run with:
R -e "rmarkdown::render('data_mag_net.Rmd', output_file='data_mag_net.pdf')"
```

```{r setup, include=FALSE}
library(knitr)
knitr::opts_chunk$set(echo=F, warning=F, cache=T, message=F, fig.width=6, fig.height=2.5)
suppressPackageStartupMessages(library('ggplot2'))
ggplot2::theme_set(theme_minimal())
library(tidyr)
library(dplyr)
library(readr)
library(mlogit)
library(stringr)
```

```{r}
# cleaner theme
my_theme <- function(base_size=10) {
  # Set the base size
  theme_bw(base_size=base_size) +
    theme(
      # Center title
      plot.title = element_text(hjust = 0.5),
      # Make the background white
      panel.background=element_rect(fill='white', colour='white'),
      panel.grid.major=element_blank(),
      panel.grid.minor=element_blank(),
      # Minimize margins
      plot.margin=unit(c(0.2, 0.2, 0.2, 0.2), "cm"),
      panel.margin=unit(0.25, "lines"),
      # Tiny space between axis labels and tick labels
      axis.title.x=element_text(margin=ggplot2::margin(t=6.0)),
      axis.title.y=element_text(margin=ggplot2::margin(r=6.0)),
      # Simplify the legend
      legend.key=element_blank(),
      legend.title=element_blank(),
      legend.background=element_rect(fill='transparent')
    )
}
```

```{r data}
d_raw = read_csv("~/choosing_to_grow/data_academic/processed/mag_net.txt", col_types='cccddccc')
# explode citations into edges
edges = d_raw %>%
  separate_rows(references, sep=',') %>%
  select(id, cites=references, year_cited=year) %>%
  left_join(d_raw %>% select(cites=id, year_published=year), by='cites')
```

* total number of papers (=nodes): `r nrow(d_raw)`
* total number of references: `r nrow(edges %>% filter(!is.na(cites)))`
* total number of references to known nodes (=edges): `r nrow(edges %>% filter(!is.na(year_published)))`
* share of references to known nodes: `r edges %>% filter(!is.na(cites)) %>% summarize(mean(!is.na(year_published))) %>% as.numeric()`

```{r plot_dist_time}
Rmisc::multiplot(
  # distribution of when papers are published
  d_raw %>%
    group_by(year) %>% summarize(n=n()) %>%
    ggplot(aes(year, n)) + geom_line() +
      scale_x_continuous("Year", limits=c(1980,2020)) +
      scale_y_continuous("# papers") +
      ggtitle("Number of papers per year") +
      my_theme(),
  # distribution of time between a papers publishing year and year of citation
  edges %>%
    mutate(delta=year_cited-year_published) %>% 
    mutate(delta=ifelse(delta < 0, NA, ifelse(delta > 40, 40, delta))) %>%
    group_by(delta) %>% summarize(n=n()) %>%
    filter(!is.na(delta)) %>%
    ggplot(aes(delta, n)) + geom_line() +
      scale_x_continuous("Delta (years)") +
      scale_y_continuous("# papers") +
      ggtitle("Distribution of Years to citation") +
      my_theme() + theme(axis.title.y=element_blank()),
  cols=2)
```

* Left: number of papers per year, linear increase since 2000, drop for recent years
* Right: distribution of years between publication and getting cited. Most citations happen within 2-3 years of publication.

Next, we compare the stated number of citations to the amount we can actually find in the data. 

```{r data_coverage}
# how many of the citations in "n_citation" do we actually observe in the data?
DF = inner_join(d_raw,
           edges %>% group_by(cites) %>% summarize(n_citation_data=n()),
           by=c('id'='cites')) %>%
  select(id, n_citation, n_citation_data) %>%
  mutate(p_citation_data=n_citation_data/n_citation) %>%
  filter(!is.na(id))
```
```{r plot_coverage}
Rmisc::multiplot(
  # density
  ggplot(DF, aes(p_citation_data)) + geom_density() +
    scale_x_continuous("Share of citations") +
    ggtitle("Share of stated citations observed") +
    my_theme(),
  # grouped
  DF %>% group_by(n_citation) %>% summarize(stat=mean(p_citation_data)) %>%
    ggplot(aes(n_citation, stat)) + geom_line() +
      scale_x_log10("(log) # citations (stated)", limits=c(40, 8000)) +
      scale_y_continuous("Share of citations observed") +
      #scale_y_log10("# citations (observed)") +
      #geom_line(data=data.frame(x=10:10000), aes(x, x), color='blue') + 
      ggtitle("Citations - Stated vs Observed") +
      my_theme(),
  cols=2
)
```

* Left: distribution of "share of stated observations observed", for mostly papers this is <25%. Since I look at the graph filtered by field of study, citing papers might not be included. The whole graph is hard to work with, so this is what we got.
* Right: per "stated number of citations", what is the average "share of citations observed"? Very stable by x, with a much higher variance for the highly cited papers (as there are fewer of them).

\newpage
Are the degree distributions similar for the stated and observed citation counts?

```{r plot_degdist, fig.height=3}
# degree distribution
rbind(
    DF %>% mutate(stat=n_citation) %>% filter(stat > 50) %>% group_by(stat) %>% summarize(n=n()) %>% mutate(g='Stated'),
    DF %>% mutate(stat=n_citation_data) %>% group_by(stat) %>% summarize(n=n()) %>% mutate(g='Observed')
  ) %>%
  ggplot(aes(stat, n)) + geom_point() + 
    scale_x_log10("(log) # citations") +
    scale_y_log10("(log) # papers") +
    ggtitle("Degree Distribution") +
    facet_wrap(~g) +
    my_theme()
```

Yes, and this shows the censoring at 50 very clearly.

**TODO**: fit $\alpha$?

```{r plot citations_time}
Rmisc::multiplot(
  edges %>%
    filter(year_published > 1950) %>%
    group_by(cites, year_published) %>% summarize(n=n()) %>%
    group_by(year_published) %>% summarize(n_citation=mean(n, na.rm=T)) %>%
    ggplot(aes(year_published, n_citation)) + geom_point() + #geom_line() +
      scale_y_continuous("Avg # citations") +
      scale_x_continuous("Year published") +
      ggtitle("Citations by Age (observed)") +
      coord_cartesian(ylim=c(0, 30)) +
      my_theme(),
  d_raw %>%
    filter(year > 1950) %>%
    group_by(year) %>% summarize(n_citation=mean(n_citation, na.rm=T)) %>%
    ggplot(aes(year, n_citation)) + geom_point() + #geom_line() +
      scale_y_continuous("Avg # citations") +
      scale_x_continuous("Year published") +
      ggtitle("Citations by Age (stated)") +
      coord_cartesian(ylim=c(45, 95)) +
      my_theme() + theme(axis.title.y=element_blank()),
  cols=2)
```

* Left: average number of citations by year of publishing (as observed). linear increase until 2000 (newer papers more cited), but then drops off
* Right: same, but as stated. The trend is the same, but the numbers are inflated by about 50.

Here is the distribution of papers/author:

```{r plot_authdist, fig.width=3, fig.height=2.5}
d_raw %>% select(authors) %>%
  separate_rows(authors, sep=',') %>%
  group_by(authors) %>% summarize(n_papers=n()) %>%
  group_by(n_papers) %>% summarize(n=n()) %>%
  ggplot(aes(n_papers, n)) + geom_point() +
    ggtitle("Distribution of papers/author") +
    scale_x_log10("(log) Number of papers") +
    scale_y_log10("(log) Number of Authors") +
    my_theme()
```

Very heavy-tailed as well.

What are the top keywords?

```{r plot_keydist}
d_raw %>% select(keywords) %>%
  separate_rows(keywords, sep=',') %>%
  mutate(keyword=keywords) %>% filter(!is.na(keyword)) %>%
  group_by(keywords) %>% summarize(n=n()) %>%
  arrange(-n) %>% head(n=10) %>%
  kable(format='markdown')
```

\newpage
## Model
Data construction process:

* sample 2500 citations from after 2011
* for each actual citation, sample 24 non-cited papers (from before publication date)
* for each of the (paper,option) pairs, compute features (n citations, years since, has same author)

```{r model_data_1}
set.seed(100)
## sample actual choices
dm1 <- edges %>%
  # only look at citations within dataset
  filter(!is.na(year_published), year_published < year_cited, year_cited > 2011) %>%
  sample_n(2500) %>%
  mutate(y=1) %>%
  select(paper_id=id, paper_year=year_cited, option_id=cites, option_year=year_published, y)
```

```{r model_data_2}
## sample reduced choice sets
dm2 <- dm1 %>%
  mutate(t='x') %>%
  select(paper_id, paper_year, t) %>%
  # cross join with all possible choices to create full choice set
  full_join(d_raw %>%
              filter(year > 1950) %>%
              select(option_id=id, option_year=year) %>%
              mutate(t='x'), by='t') %>%
  filter(option_year < paper_year) %>%
  # sample only 20 choices for reduced choice set
  group_by(paper_id) %>% sample_n(24) %>% ungroup() %>%
  mutate(y=0) %>% select(paper_id, paper_year, option_id, option_year, y) %>%
  # make sure they weren't actually cited..
  left_join(edges, by=c("paper_id"="id","option_id"="cites")) %>%
  filter(is.na(year_cited)) %>% select(-year_cited, -year_published)
```

```{r model_data_3}
# helper function to count number of overlapping items in comma-separated list string
str_overlap <- Vectorize(function(s1, s2) {
  intersect(str_split(s1, ',')[[1]], str_split(s2, ',')[[1]]) %>% length()
})

dm3 <- rbind(dm1, dm2)

## Compute features
DM <- dm3 %>%
  # n_citations
  left_join(
    # compute number of citations **at time of choosing papers' publishing**
    inner_join(dm3, edges %>% select(cites, year_cited), by=c('option_id'='cites')) %>%
      filter(paper_year > year_cited) %>%
      group_by(paper_id, option_id) %>% summarize(n_citations=n()),
    by=c('paper_id','option_id')
  ) %>%
  mutate(n_citations=ifelse(is.na(n_citations), 0, n_citations)) %>%
  # years between
  mutate(delta_years = paper_year - option_year) %>%
  # overlapping authors
  left_join(
    dm3 %>% select(paper_id, option_id) %>%
      left_join(d_raw %>% select(id, a=authors), by=c('paper_id' ='id')) %>%
      left_join(d_raw %>% select(id, b=authors), by=c('option_id'='id')) %>%
      mutate(has_same_author=ifelse(str_overlap(a, b) > 0, 1, 0)) %>% select(-a, -b),
    by=c('paper_id','option_id')
  ) %>%
  # overlapping keywords
  left_join(
    dm3 %>% select(paper_id, option_id) %>%
      left_join(d_raw %>% select(id, a=keywords), by=c('paper_id' ='id')) %>%
      left_join(d_raw %>% select(id, b=keywords), by=c('option_id'='id')) %>%
      mutate(n_same_keywords=str_overlap(a, b)) %>% select(-a, -b),
    by=c('paper_id','option_id')
  )

H <- DM %>% 
  group_by(paper_id) %>% mutate(alt_id=row_number()) %>% ungroup() %>%
  select(paper_id, alt_id, y, n_citations, delta_years, has_same_author, n_same_keywords) %>% as.data.frame() %>%
  mlogit.data(shape="long", chid.var='paper_id', choice="y", alt.var='alt_id', varying=c(4:7))
```

```{r model_model}
stargazer::stargazer(
  mlogit(y ~ log(n_citations+1) | 0, H),
  mlogit(y ~ log(n_citations+1) + log(delta_years) | 0, H),
  mlogit(y ~ log(n_citations+1) + has_same_author | 0, H),
  mlogit(y ~ log(n_citations+1) + log(delta_years) + has_same_author| 0, H),  
  mlogit(y ~ log(n_citations+1) + log(delta_years) + has_same_author + n_same_keywords| 0, H),  
  dep.var.caption = "",
  covariate.labels = c("log Citations", "log Age", "Has same author", "# same keywords"),
  type='text')
```

```{r model_model_tex, results='asis', eval=F}
stargazer::stargazer(
  mlogit(y ~ log(n_citations+1) | 0, H),
  mlogit(y ~ log(n_citations+1) + log(delta_years) | 0, H),
  mlogit(y ~ log(n_citations+1) + has_same_author | 0, H),
  mlogit(y ~ log(n_citations+1) + log(delta_years) + has_same_author| 0, H),  
  mlogit(y ~ log(n_citations+1) + log(delta_years) + has_same_author + n_same_keywords| 0, H),  
  dep.var.caption = "",
  covariate.labels = c("log Citations", "log Age", "Has same author", "n same keywords"),
  header=FALSE, 
  type='latex')
```
